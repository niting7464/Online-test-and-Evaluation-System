{% extends "base.html" %}

{% block title %}Test Attempt{% endblock %}

{% block content %}
<div class="test-attempt-container">
  <!-- Test Header with Timer -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h4 class="mb-1">{{ attempt.test.name }}</h4>
          <p class="text-muted small mb-0">
            <i class="bi bi-question-circle me-1"></i>{{ attempt.test.max_questions }} Questions | 
            <i class="bi bi-trophy me-1"></i>{{ attempt.test.total_marks }} Marks
          </p>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="timer-display-inline">
            <i class="bi bi-clock me-2"></i>
            <strong id="time-left">Loading...</strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="attempt-meta" data-attempt-id="{{ attempt.id }}" data-remaining-seconds="{{ remaining_seconds }}" data-status="{{ attempt.status }}"></div>

  <div class="row">
    <!-- Category Sidebar -->
    <div class="col-lg-3 mb-4">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Categories</h6>
        </div>
        <div class="list-group list-group-flush">
          {% for category in categories %}
          <a href="#" class="list-group-item list-group-item-action category-nav-item {% if forloop.first %}active{% endif %}" 
             data-category-index="{{ forloop.counter0 }}" 
             data-category-name="{{ category.category_name }}">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ category.category_name }}</strong>
                <div class="small text-muted">
                  {{ category.questions|length }} Question{{ category.questions|length|pluralize }}
                </div>
              </div>
              <div class="category-status" data-category-index="{{ forloop.counter0 }}">
                <span class="badge badge-secondary">0/{{ category.questions|length }}</span>
              </div>
            </div>
          </a>
          {% endfor %}
        </div>
        <div class="card-footer">
          <div class="text-center">
            <div class="small text-muted mb-2">Overall Progress</div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar" id="overall-progress" style="width: 0%;"></div>
            </div>
            <div class="small text-muted mt-2" id="overall-progress-text">0 / {{ attempt.test.max_questions }} answered</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Questions Area -->
    <div class="col-lg-9">
      <!-- Category Header (shown when category selected) -->
      <div id="category-header" class="card mb-3" style="display: none;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1" id="current-category-name">Select a category to begin</h5>
              <div class="small text-muted">
                <span id="category-progress-text">0 / 0 answered</span>
              </div>
            </div>
            <div class="progress" style="width: 200px; height: 6px;">
              <div class="progress-bar" id="category-progress-bar" style="width: 0%;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Questions Container -->
      <div id="questions-container">
        <div class="card">
          <div class="card-body text-center py-5">
            <i class="bi bi-folder2-open" style="font-size: 3rem; color: var(--gray-400);"></i>
            <h5 class="mt-3 text-muted">Select a category to view questions</h5>
            <p class="text-muted small">Click on any category from the sidebar to start answering questions</p>
          </div>
        </div>
      </div>

      <!-- Submit Test Button -->
      <div class="card mt-3" id="submit-section" style="display: none;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">Ready to Submit?</h6>
              <p class="small text-muted mb-0">Review your answers and submit when ready. You cannot change answers after submission.</p>
            </div>
            <form id="final-submit-form" method="post" action="{% url 'submit-test' attempt.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger btn-lg" id="final-submit-btn">
                <i class="bi bi-check-circle me-2"></i>Submit Test
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden template for questions -->
<div id="question-template" style="display: none;">
  <div class="question-card mb-3" data-question-id="">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-start mb-3">
          <div class="question-number me-3">1</div>
          <div class="flex-grow-1">
            <h6 class="question-text mb-3"></h6>
            
            <div class="question-options">
              <!-- Options will be inserted here -->
            </div>
            
            <div class="mt-3">
              <span class="badge badge-success answer-saved-badge" style="display: none;">
                <i class="bi bi-check-circle me-1"></i>Answer Saved
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Helper functions
  function getCookie(name) {
    let v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
    return v ? v[2] : null;
  }

  function showToast(text, success=true){
    const msg = document.createElement('div');
    msg.className = 'toast align-items-center ' + (success? 'text-bg-success':'text-bg-danger') + ' border-0 mb-2';
    msg.innerHTML = '<div class="d-flex"><div class="toast-body">' + (text || '') + '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>';
    document.getElementById('toast-container').appendChild(msg);
    try { bootstrap.Toast.getOrCreateInstance(msg, {delay:2000}).show(); } catch(e){ setTimeout(()=>msg.remove(),2000); }
  }

  // Get attempt data
  var attemptMeta = document.getElementById('attempt-meta');
  var attemptId = attemptMeta.dataset.attemptId;
  var remainingSeconds = parseInt(attemptMeta.dataset.remainingSeconds || 0, 10);
  var attemptStatus = attemptMeta.dataset.status || 'ONGOING';
  var isTestLocked = attemptStatus === 'COMPLETED';
  
  // Categories data
  var categoriesData = {{ categories_json|safe }};
  
  // Current state
  var currentCategoryIndex = null;
  var answeredQuestions = {}; // {questionId: selectedOption}
  var questionsData = {}; // Store all questions data
  
  // Show locked message if test is completed
  if (isTestLocked) {
    var container = document.querySelector('.test-attempt-container');
    if (container) {
      var resultUrl = '{% url "test-result" attempt.id %}';
      container.innerHTML = 
        '<div class="card">' +
        '<div class="card-body text-center py-5">' +
        '<i class="bi bi-lock-fill" style="font-size: 3rem; color: var(--gray-400);"></i>' +
        '<h4 class="mt-3">Test Already Submitted</h4>' +
        '<p class="text-muted">This test has been submitted and answers are locked.</p>' +
        '<a href="' + resultUrl + '" class="btn btn-primary mt-3">' +
        '<i class="bi bi-eye me-2"></i>View Results</a>' +
        '</div></div>';
    }
  }
  
  // Initialize questions data
  categoriesData.forEach(function(cat, catIdx) {
    questionsData[catIdx] = cat.questions || [];
    // Initialize answered questions from existing answers
    (cat.questions || []).forEach(function(q) {
      if (q.selected_option) {
        answeredQuestions[q.id] = q.selected_option;
      }
    });
  });

  // Timer - Fixed time display
  var timeDisplay = document.getElementById('time-left');
  function formatTime(totalSeconds) {
    if (totalSeconds <= 0) return '0:00';
    
    var hours = Math.floor(totalSeconds / 3600);
    var minutes = Math.floor((totalSeconds % 3600) / 60);
    var seconds = totalSeconds % 60;
    
    if (hours > 0) {
      return hours + 'h ' + (minutes < 10 ? '0' : '') + minutes + 'm ' + (seconds < 10 ? '0' : '') + seconds + 's';
    } else if (minutes > 0) {
      return minutes + 'm ' + (seconds < 10 ? '0' : '') + seconds + 's';
    } else {
      return seconds + 's';
    }
  }
  
  // Initialize timer display
  if (timeDisplay && !isTestLocked) {
    // Ensure remainingSeconds is valid
    if (isNaN(remainingSeconds) || remainingSeconds < 0) {
      remainingSeconds = 0;
    }
    
    timeDisplay.textContent = formatTime(remainingSeconds);
    
    var timer = setInterval(function() {
      remainingSeconds = Math.max(0, remainingSeconds - 1);
      if (timeDisplay) {
        timeDisplay.textContent = formatTime(remainingSeconds);
      }
      
      if (remainingSeconds <= 0) {
        clearInterval(timer);
        // Auto-submit
        var submitForm = document.getElementById('final-submit-form');
        if (submitForm) {
          submitForm.submit();
        }
      }
    }, 1000);
  } else if (timeDisplay && isTestLocked) {
    timeDisplay.textContent = 'Test Completed';
  }

  // Auto-save answer function
  function saveAnswer(questionId, selectedOption) {
    if (isTestLocked) {
      showToast('Test has been submitted. Answers are locked.', false);
      return;
    }
    
    var formData = new FormData();
    formData.append('attempt', attemptId);
    formData.append('question', questionId);
    formData.append('selected_option', selectedOption);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

    fetch('{% url "submit-answer" %}', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (data && data.message) {
        answeredQuestions[questionId] = selectedOption;
        updateProgress();
        // Show saved badge
        var questionCard = document.querySelector('.question-card[data-question-id="' + questionId + '"]');
        if (questionCard) {
          questionCard.classList.add('answered');
          var badge = questionCard.querySelector('.answer-saved-badge');
          if (badge) badge.style.display = 'inline-block';
        }
        showToast('Answer saved', true);
      } else if (data && data.detail) {
        showToast(data.detail, false);
        if (data.detail.includes('submitted') || data.detail.includes('time over')) {
          isTestLocked = true;
          location.reload();
        }
      }
    })
    .catch(err => {
      console.error('Save failed:', err);
      showToast('Failed to save answer', false);
    });
  }

  // Render questions for a category
  function renderCategoryQuestions(categoryIndex) {
    if (categoryIndex === null || !questionsData[categoryIndex]) return;
    
    var category = categoriesData[categoryIndex];
    var questions = questionsData[categoryIndex];
    var container = document.getElementById('questions-container');
    
    container.innerHTML = '';
    
    if (questions.length === 0) {
      container.innerHTML = '<div class="card"><div class="card-body text-center py-5"><p class="text-muted">No questions in this category.</p></div></div>';
      return;
    }
    
    questions.forEach(function(q, idx) {
      var questionCard = document.createElement('div');
      questionCard.className = 'question-card mb-3';
      questionCard.setAttribute('data-question-id', q.id);
      if (answeredQuestions[q.id]) {
        questionCard.classList.add('answered');
      }
      
      var isAnswered = !!answeredQuestions[q.id];
      var selectedOption = answeredQuestions[q.id] || null;
      
      questionCard.innerHTML = `
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-start mb-3">
              <div class="question-number me-3">${idx + 1}</div>
              <div class="flex-grow-1">
                <h6 class="question-text mb-3">${q.question_text}</h6>
                
                <div class="question-options">
                  ${Object.keys(q.options).map(function(key) {
                    var optionText = q.options[key];
                    var isSelected = selectedOption === key;
                    return `
                      <div class="form-check mb-2 p-2 option-item ${isSelected ? 'selected' : ''}" style="border: 1px solid var(--gray-300); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s;">
                        <input class="form-check-input" type="radio" 
                               name="question_${q.id}" 
                               value="${key}" 
                               id="q${q.id}_${key}"
                               ${isSelected ? 'checked' : ''}>
                        <label class="form-check-label w-100" for="q${q.id}_${key}" style="cursor: pointer;">
                          <strong class="me-2">${key}.</strong>${optionText}
                        </label>
                      </div>
                    `;
                  }).join('')}
                </div>
                
                <div class="mt-3">
                  <span class="badge badge-success answer-saved-badge" style="display: ${isAnswered ? 'inline-block' : 'none'};">
                    <i class="bi bi-check-circle me-1"></i>Answer Saved
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(questionCard);
      
      // Disable inputs if test is locked
      if (isTestLocked) {
        questionCard.querySelectorAll('input[type="radio"]').forEach(function(radio) {
          radio.disabled = true;
        });
        questionCard.querySelectorAll('.option-item').forEach(function(item) {
          item.style.cursor = 'not-allowed';
          item.style.opacity = '0.7';
        });
      } else {
        // Add auto-save on radio change
        questionCard.querySelectorAll('input[type="radio"]').forEach(function(radio) {
          radio.addEventListener('change', function() {
            if (this.checked) {
              saveAnswer(q.id, this.value);
              // Update visual state
              questionCard.querySelectorAll('.option-item').forEach(function(item) {
                item.classList.remove('selected');
              });
              this.closest('.option-item').classList.add('selected');
            }
          });
        });
      }
    });
  }

  // Update progress indicators
  function updateProgress() {
    var totalQuestions = 0;
    var totalAnswered = 0;
    
    categoriesData.forEach(function(cat, catIdx) {
      var questions = questionsData[catIdx] || [];
      var answered = questions.filter(function(q) { return answeredQuestions[q.id]; }).length;
      totalQuestions += questions.length;
      totalAnswered += answered;
      
      // Update category badge
      var categoryNav = document.querySelector('.category-nav-item[data-category-index="' + catIdx + '"]');
      if (categoryNav) {
        var statusBadge = categoryNav.querySelector('.category-status');
        if (statusBadge) {
          statusBadge.innerHTML = '<span class="badge ' + (answered === questions.length && questions.length > 0 ? 'badge-success' : 'badge-secondary') + '">' + answered + '/' + questions.length + '</span>';
        }
      }
    });
    
    // Update overall progress
    var overallProgress = document.getElementById('overall-progress');
    var overallProgressText = document.getElementById('overall-progress-text');
    if (overallProgress && totalQuestions > 0) {
      var percentage = (totalAnswered / totalQuestions) * 100;
      overallProgress.style.width = percentage + '%';
      overallProgressText.textContent = totalAnswered + ' / ' + totalQuestions + ' answered';
    }
    
    // Update category progress if category is open
    if (currentCategoryIndex !== null) {
      var category = categoriesData[currentCategoryIndex];
      var questions = questionsData[currentCategoryIndex] || [];
      var answered = questions.filter(function(q) { return answeredQuestions[q.id]; }).length;
      
      var categoryProgressText = document.getElementById('category-progress-text');
      var categoryProgressBar = document.getElementById('category-progress-bar');
      
      if (categoryProgressText) {
        categoryProgressText.textContent = answered + ' / ' + questions.length + ' answered';
      }
      if (categoryProgressBar && questions.length > 0) {
        var percentage = (answered / questions.length) * 100;
        categoryProgressBar.style.width = percentage + '%';
      }
    }
    
    // Show submit section if any questions answered
    var submitSection = document.getElementById('submit-section');
    if (submitSection && totalAnswered > 0) {
      submitSection.style.display = 'block';
    }
  }

  // Category navigation
  document.querySelectorAll('.category-nav-item').forEach(function(item) {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      var categoryIndex = parseInt(this.dataset.categoryIndex);
      
      // Update active state
      document.querySelectorAll('.category-nav-item').forEach(function(nav) {
        nav.classList.remove('active');
      });
      this.classList.add('active');
      
      // Show category
      currentCategoryIndex = categoryIndex;
      var category = categoriesData[categoryIndex];
      
      // Update category header
      var categoryHeader = document.getElementById('category-header');
      var categoryName = document.getElementById('current-category-name');
      if (categoryHeader && categoryName) {
        categoryHeader.style.display = 'block';
        categoryName.textContent = category.category_name;
      }
      
      // Render questions
      renderCategoryQuestions(categoryIndex);
      updateProgress();
    });
  });

  // Initialize - show first category if exists
  if (categoriesData.length > 0) {
    var firstCategory = document.querySelector('.category-nav-item');
    if (firstCategory) {
      firstCategory.click();
    }
  }

  // Initialize progress
  updateProgress();
})();
</script>

<style>
.question-number {
  width: 35px;
  height: 35px;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  flex-shrink: 0;
}

.question-card.answered {
  border-left: 4px solid var(--success);
}

.option-item:hover {
  background: var(--gray-50);
  border-color: var(--primary) !important;
}

.option-item.selected {
  background: var(--info-light);
  border-color: var(--info) !important;
}

.category-nav-item.active {
  background: var(--gray-50);
  border-left: 3px solid var(--primary);
}

.timer-display-inline {
  font-size: 1.1rem;
  color: var(--gray-700);
}

.timer-display-inline strong {
  color: var(--primary);
  font-size: 1.25rem;
}
</style>
{% endblock %}
