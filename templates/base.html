<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Online Test System{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    {% load static %}
    {% load tz %}
    <link rel="stylesheet" href="{% static 'css/auth.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'dashboard' %}">Mindsprint</a>

    <div class="collapse navbar-collapse">
      <div class="ms-auto d-flex align-items-center">
        {% if user.is_authenticated %}
          <div class="dropdown">
            <a class="btn btn-light btn-icon dropdown-toggle" href="#" role="button" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <div class="profile-avatar">{{ user.username|slice:":1"|upper }}</div>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
              <li>
                <div class="px-3 py-3 d-flex align-items-center profile-card">
                  <div class="me-3">
                    <div class="profile-avatar">{{ user.username|slice:":1"|upper }}</div>
                  </div>
                  <div class="flex-fill">
                    <div class="fw-semibold">{{ user.get_full_name }}</div>
                    <div class="text-muted small text-truncate" style="max-width:180px;">{{ user.email }}</div>
                    <div class="text-muted small mt-1">Member since {{ user.date_joined|date:"F Y" }}</div>
                  </div>
                  
                </div>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{% url 'edit-email_page' %}"><i class="bi bi-envelope me-2 text-muted"></i> Edit email</a></li>
              <li><a class="dropdown-item" href="{% url 'change-password_page' %}"><i class="bi bi-lock me-2 text-muted"></i> Change password</a></li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <form method="post" action="{% url 'logout' %}">{% csrf_token %}
                  <button class="dropdown-item text-danger" type="submit"><i class="bi bi-box-arrow-right me-2 text-muted"></i> Logout</button>
                </form>
              </li>
            </ul>
          </div>
        {% else %}
          <div class="ms-auto">
            <a href="/login/" class="btn btn-sm btn-primary me-2">
              <i class="bi bi-box-arrow-in-right me-1"></i>Login
            </a>
            <a href="/register/" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-person-plus me-1"></i>Register
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</nav>


{# Toast container: fixed, does not shift page layout #}
<div class="toast-container position-fixed bottom-0 start-50 translate-middle-x pb-3" id="toast-container" aria-live="polite" aria-atomic="true">
  {% for message in messages %}
    <div class="toast align-items-center text-bg-{{ message.tags }} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">{{ message|safe }}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  {% endfor %}
</div>

<div class="container mt-5">
    {% block content %}{% endblock %}
</div>

<!-- Removed inline modals; Edit Email and Change Password are separate pages -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Initialize and show all Bootstrap toasts from the container
        var toasts = document.querySelectorAll('#toast-container .toast');
        toasts.forEach(function (t) {
          try {
            var bs = bootstrap.Toast.getOrCreateInstance(t, { delay: 2500, autohide: true });
            bs.show();
          } catch (err) {
            // fallback: remove after timeout
            setTimeout(function () { t.remove(); }, 2500);
          }
        });

        // Close toast when CTA inside it is clicked
        document.body.addEventListener('click', function (e) {
          var target = e.target;
          if (target && target.classList && target.classList.contains('cta-dismiss')) {
            var toastEl = target.closest('.toast');
            if (toastEl) {
              try {
                bootstrap.Toast.getOrCreateInstance(toastEl).hide();
              } catch (err) {
                toastEl.remove();
              }
            }
          }
        }, false);

        // Initialize dropdowns explicitly (helps ensure Bootstrap binds handlers)
        try {
          var ddToggles = document.querySelectorAll('.dropdown-toggle');
          ddToggles.forEach(function (el) {
            try { new bootstrap.Dropdown(el); } catch (err) { /* ignore */ }
          });
        } catch (err) {
          // ignore
        }

        // No modals in base; Edit Email and Change Password open pages

        // Ensure clicks always toggle dropdowns using Bootstrap API with fallback
        try {
          document.querySelectorAll('.dropdown-toggle').forEach(function(btn){
            btn.addEventListener('click', function(e){
              e.stopPropagation();
              try {
                var inst = bootstrap.Dropdown.getOrCreateInstance(btn);
                inst.toggle();
              } catch (err) {
                // fallback: toggle classes manually
                var parent = btn.closest('.dropdown');
                var menu = parent && parent.querySelector('.dropdown-menu');
                if (!menu) return;
                var isShown = menu.classList.contains('show');
                document.querySelectorAll('.dropdown-menu.show').forEach(function(m){ m.classList.remove('show'); if (m.closest('.dropdown')) m.closest('.dropdown').classList.remove('show'); });
                if (!isShown) { menu.classList.add('show'); parent.classList.add('show'); btn.setAttribute('aria-expanded','true'); }
              }
            }, false);
          });
          // close dropdowns when clicking elsewhere
          document.addEventListener('click', function(ev){
            if (!ev.target.closest('.dropdown')) {
              document.querySelectorAll('.dropdown-menu.show').forEach(function(m){ m.classList.remove('show'); if (m.closest('.dropdown')) m.closest('.dropdown').classList.remove('show'); });
              document.querySelectorAll('.dropdown-toggle[aria-expanded="true"]').forEach(function(b){ b.setAttribute('aria-expanded','false'); });
            }
          }, false);
        } catch (err) {
          // ignore
        }
      });
    </script>
</body>
</html>
